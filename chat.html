<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RigRadar AI | Workspace</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="style.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; padding-top: 64px; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        .msg-ai { background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px 12px 12px 0;
    padding: 12px;
    color: #d1d5db;
    line-height: 1.6;
    white-space: normal; 
    word-break: break-word; }
        .msg-user { background: linear-gradient(135deg, #2563eb, #1d4ed8); border: 1px solid rgba(59, 130, 246, 0.5); }
        
        .active-chat { background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); color: white; }
        .glass-panel { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        .radar-scan-line {
            width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            position: absolute; left: 0;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 10px #3b82f6;
            opacity: 0;
        }
        .scanning .radar-scan-line { opacity: 1; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="overflow-hidden relative">

    <div id="header-placeholder" class="fixed top-0 left-0 w-full z-[1000]"></div>

   <div class="flex h-[calc(100dvh-64px)] overflow-hidden relative">

        <aside id="sidebar" class="fixed inset-y-0 left-0 w-[85%] md:w-64 bg-[#0a0a0a] border-r border-white/5 z-[101] transform -translate-x-full lg:translate-x-0 lg:static flex flex-col p-4 gap-4 transition-transform shadow-2xl lg:shadow-none pt-20 lg:pt-4">
            <div class="flex justify-between items-center lg:hidden px-2 mb-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">History</span>
                <button onclick="toggleSidebar()" class="text-gray-400 p-2 hover:text-white">‚úï</button>
            </div>
            <button onclick="startNewChat(); toggleSidebar()" class="w-full border border-white/10 bg-white/5 hover:bg-white/10 py-3 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 text-white">
                <span>+</span> New Chat
            </button>
            <div class="hidden lg:block text-[10px] uppercase tracking-widest text-gray-600 font-bold mt-2 px-2">History</div>
            <div id="chat-list" class="flex-1 overflow-y-auto space-y-2 text-sm text-gray-400 pb-20 lg:pb-0"></div>
        </aside>
        
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-[100] hidden lg:hidden backdrop-blur-sm"></div>

        <main class="flex-1 flex flex-col relative bg-[#050505] w-full bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-blue-900/10 via-[#050505] to-[#050505]">
            
            <div class="md:hidden flex border-b border-white/5 bg-[#0a0a0a]/80 backdrop-blur-md z-50">
                <button onclick="switchTab('chat')" id="tab-chat" class="flex-1 py-3.5 text-xs font-bold uppercase tracking-widest tab-active transition-all">üí¨ AI Advisor</button>
                <button onclick="switchTab('radar')" id="tab-radar" class="flex-1 py-3.5 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-gray-300 transition-all">üì° Radar Control</button>
            </div>

            <div class="flex-1 flex flex-row overflow-hidden relative">
                
<div id="view-chat" class="w-full md:w-1/2 lg:w-7/12 h-full flex flex-col relative border-r border-white/5 transition-all bg-[#0a0a0a]/30">
    <div class="lg:hidden absolute top-4 left-4 z-[50]">
        <button onclick="toggleSidebar()" class="bg-[#1a1a1a] border border-white/10 p-2.5 rounded-xl text-gray-400 hover:text-white shadow-lg backdrop-blur-md">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>
    
    <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-[#050505] to-transparent z-10 pointer-events-none"></div>
    
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pt-20 lg:pt-8 custom-scrollbar z-0"> 
    </div>

<div class="w-full p-4 md:p-6 bg-[#050505] border-t border-white/5 z-20 shrink-0 relative" style="padding-bottom: max(1rem, env(safe-area-inset-bottom));">
    <div class="flex flex-col gap-2 max-w-4xl mx-auto w-full">
        
<div id="image-preview-container" class="hidden relative w-20 h-20 ml-2">
    <img id="image-preview" src="" class="w-full h-full object-cover rounded-xl border border-white/20 shadow-lg" />
            <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] font-bold shadow-lg transition-colors">‚úï</button>
        </div>

        <div class="flex gap-2 md:gap-3 items-end w-full">
            <input type="file" id="image-upload" accept="image/jpeg, image/png, image/webp" class="hidden" onchange="handleImageSelect(event)" />
            
            <button onclick="document.getElementById('image-upload').click()" class="bg-[#111] border border-white/10 hover:border-white/20 text-gray-400 hover:text-white h-12 w-12 md:h-14 md:w-14 rounded-2xl transition-all shadow-2xl flex-shrink-0 flex items-center justify-center">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
            </button>

            <div class="flex-1 bg-[#111] border border-white/10 hover:border-white/20 focus-within:border-blue-500/50 rounded-2xl flex items-center px-3 md:px-4 shadow-2xl transition-all duration-300 relative overflow-hidden group min-h-[48px] md:min-h-[56px]">
                <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-focus-within:opacity-100 transition-opacity pointer-events-none"></div>
                <textarea id="user-input" rows="1" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }" placeholder="Message AI Advisor..." class="flex-1 bg-transparent outline-none text-white py-3 md:py-4 text-sm md:text-base placeholder-gray-600 resize-none max-h-32 custom-scrollbar relative z-10 self-center m-0 leading-tight"></textarea>
            </div>
            
            <button onclick="sendMessage()" class="bg-white text-black hover:bg-gray-200 h-12 w-12 md:h-14 md:w-14 rounded-2xl transition-all shadow-[0_0_20px_rgba(255,255,255,0.1)] active:scale-95 flex-shrink-0 flex items-center justify-center">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 19V5m0 0l-7 7m7-7l7 7"></path></svg>
            </button>
        </div>
    </div>
    <div class="text-center mt-3 text-[10px] text-gray-500 font-mono">RigRadar AI can make mistakes. Verify critical specifications.</div>
</div>
</div>

                <div id="view-radar" class="w-full md:w-1/2 lg:w-9/12 h-full bg-[#050505] overflow-y-auto p-4 md:p-6 hidden md:flex flex-col space-y-6 custom-scrollbar relative">
                    
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjIiIGN5PSIyMiIgcj0iMSIgZmlsbD0icmdiYSg1OSwgMTMwLCAyNDYsIDAuMDgpIi8+PC9zdmc+')] pointer-events-none opacity-50"></div>

                    <div class="glass-panel p-6 rounded-3xl space-y-5 shadow-2xl relative" id="scanner-container">
                        <div class="radar-scan-line"></div>
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                                <span>üì°</span> Satellite Control
                            </h3>
                            <span class="text-[9px] font-mono border border-blue-500/30 text-blue-500 px-2 py-0.5 rounded-full bg-blue-500/10">READY</span>
                        </div>
                        
                        <div class="flex flex-col gap-4 relative z-10">
                            <div class="bg-black/60 border border-white/5 rounded-2xl p-2 flex items-center gap-2 focus-within:border-blue-500/50 transition-colors">
                                <span class="pl-3 text-gray-500">üîç</span>
                                <input type="text" id="scanQuery" placeholder="Target hardware (e.g. RTX 4080)" class="w-full bg-transparent text-white px-2 py-2 focus:outline-none text-sm placeholder-gray-600 font-medium">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-black/60 border border-white/5 rounded-2xl p-2 flex items-center gap-2 focus-within:border-blue-500/50 transition-colors">
                                    <span class="pl-2 text-gray-500">üè™</span>
                                    <input type="text" id="custom-store" placeholder="Stores (e.g. ebay, amazon)" class="w-full bg-transparent text-white px-1 py-1.5 focus:outline-none text-xs placeholder-gray-600" title="Comma separated stores">
                                </div>
                                <div class="flex bg-black/60 border border-white/5 rounded-2xl overflow-hidden focus-within:border-blue-500/50 transition-colors">
                                    <input type="number" id="min-price" placeholder="Min $" class="w-1/2 bg-transparent text-white px-2 py-2.5 focus:outline-none text-xs text-center border-r border-white/5 placeholder-gray-600">
                                    <input type="number" id="max-price" placeholder="Max $" class="w-1/2 bg-transparent text-white px-2 py-2.5 focus:outline-none text-xs text-center placeholder-gray-600">
                                </div>
                            </div>            
                            <div class="bg-black/40 border border-white/5 p-1 rounded-xl flex gap-1 relative mt-1">
                                <input type="hidden" id="condition-val" value="any">
                                <button onclick="setCondition('any', this)" class="cond-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest rounded-lg bg-blue-600/20 text-blue-400 border border-blue-500/30 transition-all">ANY</button>
                                <button onclick="setCondition('new', this)" class="cond-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest rounded-lg bg-transparent text-gray-500 hover:text-gray-300 transition-all border border-transparent">NEW</button>
                                <button onclick="setCondition('used', this)" class="cond-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest rounded-lg bg-transparent text-gray-500 hover:text-gray-300 transition-all border border-transparent">USED</button>
                            </div>
                        </div>
                        
                        <button onclick="requestScan()" id="scan-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl transition-all uppercase tracking-[0.2em] text-xs shadow-[0_0_20px_rgba(37,99,235,0.3)] active:scale-[0.98] relative z-10 mt-2">
                            Deploy Scanner
                        </button>
                                <button onclick="openWatchdogModal()" class="w-full bg-transparent border border-yellow-500/50 hover:bg-yellow-500/10 text-yellow-500 font-bold py-3 rounded-xl transition-all uppercase tracking-widest text-[10px] mt-2 flex items-center justify-center gap-2">
                            <span>üîî</span> Setup Price Watchdog
                        </button>
                        <div id="scanStatus" class="text-center text-[11px] font-mono h-4 text-gray-500"></div>
                    </div>

                    <div class="glass-panel p-6 rounded-3xl relative z-10">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Market Analytics</h3>
                            <span id="chart-title" class="text-[10px] font-mono text-blue-400 truncate max-w-[150px] bg-blue-500/10 px-2 py-1 rounded">Awaiting scan...</span>
                        </div>
                        <div class="w-full h-36 bg-black/20 rounded-xl p-2 border border-white/5">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col relative z-10">
                        <div class="flex justify-between items-end mb-4 px-1">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Intercepted Signals</h3>
                            <span class="text-[10px] text-gray-600 font-mono">Live Session</span>
                        </div>
                        
                        <div class="mb-3 px-1">
                            <div class="bg-black/40 border border-white/5 focus-within:border-blue-500/50 rounded-lg flex items-center px-3 py-1.5 transition-all">
                                <span class="text-gray-500 mr-2 text-[10px]">üîç</span>
                                <input type="text" id="history-search" onkeyup="filterHistory()" placeholder="Search deals..." class="w-full bg-transparent outline-none text-white text-[10px] placeholder-gray-600">
                            </div>
                        </div>

                        <div id="history-list" class="space-y-3 flex-1 overflow-y-auto custom-scrollbar pr-2 pb-10">
                            <div class="flex flex-col items-center justify-center h-32 text-center border border-white/5 rounded-2xl bg-black/20 border-dashed">
                                <span class="text-2xl mb-2 opacity-50">üõ∞Ô∏è</span>
                                <span class="text-xs text-gray-600 font-mono">Radar is standing by.<br>Deploy scanner to intercept data.</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

<div id="detail-modal" class="fixed inset-0 z-[300] hidden overflow-y-auto bg-black/80 backdrop-blur-sm transition-all opacity-0">
    <div class="min-h-screen flex items-start sm:items-center justify-center p-4 pt-16 sm:pt-4">
        <div class="glass-panel w-full max-w-lg rounded-[32px] p-8 relative shadow-2xl transition-all duration-300">
            <button onclick="MarketUI.closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl z-10">‚úï</button>
        
        <div class="w-full h-40 bg-white/5 rounded-2xl mb-6 flex items-center justify-center overflow-hidden border border-white/10 relative">
            <img id="modal-img" src="logo.png" alt="Product" class="h-full object-contain relative z-10 drop-shadow-lg">
        </div>

        <div class="flex items-center gap-2 mb-4">
            <div id="modal-badge" class="px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] uppercase font-bold tracking-widest">STORE</div>
            <div id="modal-forecast"></div>
        </div>
        
        <h2 id="modal-title" class="text-xl font-bold text-white leading-tight mb-2">---</h2>
        <div id="modal-price" class="text-4xl font-black text-blue-500 tracking-tighter mb-6">$---</div>
        
        <p id="modal-opinion" class="text-gray-400 italic text-sm mb-4 bg-black/30 p-4 rounded-xl border border-white/5">---</p>

        <div class="mb-6">
            <div class="text-[10px] uppercase font-bold text-gray-500 mb-2">Store Specs</div>
            <div id="modal-desc" class="text-gray-400 text-xs leading-relaxed max-h-24 overflow-y-auto pr-2 border-l-2 border-white/10 pl-3">
                ---
            </div>
        </div>

        <div class="flex gap-3">
            <a id="modal-link" href="#" target="_blank" class="flex-grow bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-center uppercase text-sm tracking-wider transition-all">
                BUY NOW ‚Üó
            </a>
        </div>
    </div>
</div>
</div>
    <div id="watchdog-modal" class="fixed inset-0 z-[400] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-all opacity-0">
    <div class="glass-panel w-full max-w-md rounded-[32px] p-8 relative shadow-2xl transition-all duration-300 transform scale-95 border border-yellow-500/20">
        <button onclick="closeWatchdogModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white text-2xl z-10">‚úï</button>
        
        <div class="flex items-center gap-3 mb-2">
            <span class="text-3xl drop-shadow-[0_0_15px_rgba(234,179,8,0.5)]">üêï</span>
            <h2 class="text-xl font-black text-white tracking-tight">Deploy Watchdog</h2>
        </div>
        
        <p class="text-xs text-gray-400 mb-6">Set your target parameters. The satellite will scan continuously and email you when the price drops below your target.</p>
        
        <div class="space-y-4">
            <div>
                <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-1 block">Target Hardware</label>
                <input type="text" id="wd-modal-query" placeholder="e.g. RTX 4080 Super" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-yellow-500/50 transition-colors">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-1 block">Target Price (Max $)</label>
                    <input type="number" id="wd-modal-price" placeholder="e.g. 800" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-yellow-500/50 transition-colors text-center font-bold text-yellow-500">
                </div>
                <div>
                    <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-1 block">Stores (comma separated)</label>
                    <input type="text" id="wd-modal-stores" placeholder="ebay, amazon" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-yellow-500/50 transition-colors text-center">
                </div>
            </div>

            <div>
                <label class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-1 block">Scan Interval</label>
                <select id="wd-modal-interval" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-gray-300 focus:outline-none focus:border-yellow-500/50 transition-colors cursor-pointer appearance-none text-center font-bold">
                    <option value="3600">Every 1 Hour</option>
                    <option value="21600">Every 6 Hours</option>
                    <option value="43200">Every 12 Hours</option>
                    <option value="86400">Every 24 Hours</option>
                </select>
            </div>
        </div>

        <button onclick="submitWatchdog()" id="wd-modal-submit" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 rounded-xl transition-all uppercase tracking-[0.1em] text-xs shadow-[0_0_20px_rgba(234,179,8,0.3)] mt-8">
            Activate Watchdog
        </button>
    </div>
</div>
    <script src="auth.js"></script>
    <script src="market.js"></script>
    <script>
        function switchTab(tab) {
            const chatView = document.getElementById('view-chat');
            const radarView = document.getElementById('view-radar');
            const chatBtn = document.getElementById('tab-chat');
            const radarBtn = document.getElementById('tab-radar');

            if (tab === 'chat') {
                chatView.classList.remove('hidden'); radarView.classList.add('hidden');
                chatBtn.classList.add('tab-active'); chatBtn.classList.remove('text-gray-500');
                radarBtn.classList.remove('tab-active'); radarBtn.classList.add('text-gray-500');
            } else {
                chatView.classList.add('hidden'); radarView.classList.remove('hidden'); radarView.classList.add('flex');
                radarBtn.classList.add('tab-active'); radarBtn.classList.remove('text-gray-500');
                chatBtn.classList.remove('tab-active'); chatBtn.classList.add('text-gray-500');
            }
        }
        
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                document.getElementById('view-chat').classList.remove('hidden');
                document.getElementById('view-radar').classList.remove('hidden');
                document.getElementById('view-radar').classList.add('flex');
            } else {
                switchTab('chat');
            }
        });

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if (sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full'); ov.classList.add('hidden');
            }
        }

        function setCondition(value, clickedBtn) {
            document.getElementById('condition-val').value = value;
            const buttons = document.querySelectorAll('.cond-btn');
            buttons.forEach(btn => {
                btn.className = "cond-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest rounded-lg bg-transparent text-gray-500 hover:text-gray-300 transition-all border border-transparent";
            });
            clickedBtn.className = "cond-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-widest rounded-lg bg-blue-600/30 text-white border border-blue-500/50 transition-all shadow-[0_0_10px_rgba(37,99,235,0.2)]";
        }

        let activeChatId = null;
        let allChats = {};
        function formatAIResponse(text) {
            if (!text) return "";
            
            const lines = text.split('\n').filter(line => line.trim() !== "");
            
            return lines.map(line => {
                const trimmed = line.trim();
                
                if (trimmed.startsWith('‚Ä¢') || trimmed.startsWith('-')) {
                    const content = trimmed.replace(/^[-‚Ä¢]\s*/, '');
                    return `<div class="flex gap-2 items-start mb-2 ml-2">
                                <span class="text-blue-500">‚Ä¢</span>
                                <span class="text-gray-300">${content}</span>
                            </div>`;
                }
                
                return `<p class="mb-4 last:mb-0 leading-relaxed text-gray-300">${trimmed}</p>`;
            }).join('');
        }

        async function loadSidebar() {
            const email = localStorage.getItem('rr_user_email');
            if (!email) return; 

            try {
                const res = await fetch('/api/chat'); 
                const data = await res.json();
                allChats = data.chats || {};
                
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                
                Object.keys(allChats).sort((a, b) => {
                    const timeA = parseInt(a.split('_')[1]) || 0;
                    const timeB = parseInt(b.split('_')[1]) || 0;
                    return timeB - timeA; 
                }).forEach(id => {
                    const btn = document.createElement('button');
                    btn.className = `w-full text-left p-3 rounded-lg hover:bg-white/5 truncate transition-all text-xs border border-transparent ${activeChatId === id ? 'active-chat' : 'border-transparent'}`;
                    btn.innerText = allChats[id].title || "Conversation";
                    btn.onclick = () => { switchChat(id); if(window.innerWidth < 768) toggleSidebar(); };
                    list.appendChild(btn);
                });
            } catch (e) {
                console.error("Failed to load sidebar", e);
            }
        }

        async function switchChat(id) {
            activeChatId = id;
            const chatBox = document.getElementById('chat-box');
            
            chatBox.innerHTML = `
                <div class="msg-ai p-5 rounded-2xl rounded-tl-none max-w-[90%] text-gray-300 text-sm leading-relaxed mb-4">
                    <div class="text-[10px] uppercase tracking-wider text-blue-500 font-bold mb-1">RigRadar AI</div>
                    Hello! I'm your personal hardware advisor. I've decrypted our previous logs. How can I help you continue?
                </div>
                <div id="loading-history" class="flex items-center gap-2 mb-3 border-b border-white/5 pb-3">
                    <div class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-[10px] shadow-[0_0_10px_rgba(37,99,235,0.5)]">ü§ñ</div>
                    <span class="text-[10px] uppercase tracking-widest text-blue-400 animate-pulse font-bold">Decrypting logs...</span>
                </div>`;
            
            try {
                const res = await fetch(`/api/chat?chatId=${id}`);
                const data = await res.json();
                
                const loadingEl = document.getElementById('loading-history');
                if (loadingEl) loadingEl.remove();
                
                if (data.history && data.history.length > 0) {
                    data.history.forEach(msg => {
                        const isUser = msg.role === 'user';
                        const formattedText = isUser ? msg.text : formatAIResponse(msg.text);
                        
                        chatBox.innerHTML += `
                            <div class="${isUser ? 'msg-user self-end ml-auto text-white' : 'msg-ai text-gray-300'} p-4 rounded-2xl ${isUser ? 'rounded-tr-none' : 'rounded-tl-none'} max-w-[85%] text-sm leading-relaxed mb-2 shadow-md">
                                ${formattedText}
                            </div>`;
                    });
                }
                chatBox.scrollTop = chatBox.scrollHeight;
                loadSidebar(); 
            } catch (e) {
                chatBox.innerHTML += '<div class="text-center text-red-500 text-xs mt-4">Failed to establish connection to archives.</div>';
            }
        }
        function insertAndResize(text) {
    const input = document.getElementById('user-input');
    if (!input) return;
    
    input.value = text;
    input.focus();
    
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
}
function startNewChat() {
    activeChatId = null;
    const chatBox = document.getElementById('chat-box');
    chatBox.innerHTML = `
        <div class="msg-ai p-5 rounded-2xl rounded-tl-none max-w-[90%] text-gray-300 text-sm leading-relaxed" id="welcome-msg">
            <div class="text-[10px] uppercase tracking-wider text-blue-500 font-bold mb-1">RigRadar AI</div>
            <p class="mb-4">System ready. What hardware are we hunting today?</p>
            
<button onclick="insertAndResize('Check my PC for bottlenecks and suggest upgrades:\\nCPU: \\nGPU: \\nRAM: \\nPSU:')" class="px-4 py-2 rounded-full bg-white/5 border border-white/10 text-xs text-gray-400 hover:bg-white/10 hover:text-white transition-all whitespace-nowrap">
   <span>‚ö°</span> Evaluate my current PC setup
</button>
        </div>`;
    if (typeof loadSidebar === 'function') loadSidebar(); 
}
        let selectedImage = null;

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                if(window.MarketUI) MarketUI.showToast("Image is too large. Max 5MB.", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result.split(',')[1];
                selectedImage = {
                    data: base64String,
                    mimeType: file.type,
                    url: e.target.result
                };
                
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedImage = null;
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
        }

async function sendMessage() {
            const input = document.getElementById('user-input');
            const email = localStorage.getItem('rr_user_email');
            const message = input.value.trim();
            
            if(!message && !selectedImage) return;
            if(!email) { alert("Please log in first!"); return; } 

            const chatBox = document.getElementById('chat-box');
            
            let userHtml = `<div class="flex flex-col items-end w-full mb-2">`;            
            if (selectedImage) {
                userHtml += `<img src="${selectedImage.url}" class="max-w-[70%] md:max-w-[50%] h-auto rounded-2xl mb-2 border border-white/10 shadow-lg object-contain bg-[#0a0a0a]" />`;
            }
            if (message) {
                userHtml += `<div class="msg-user p-4 rounded-2xl rounded-tr-none max-w-[85%] text-white text-sm shadow-md">${message}</div>`;
            }
            userHtml += `</div>`;
            chatBox.innerHTML += userHtml;
            input.value = '';
            input.style.height = 'auto';
            
            const imagePayload = selectedImage ? { data: selectedImage.data, mimeType: selectedImage.mimeType } : null;
            clearImage();
            
            chatBox.scrollTop = chatBox.scrollHeight;

            const typingId = "typing-" + Date.now();
            chatBox.innerHTML += `
                <div class="msg-ai p-4 rounded-2xl rounded-tl-none max-w-[85%] text-gray-300 text-sm mt-2 leading-relaxed shadow-md" id="container-${typingId}">
                    <div id="${typingId}"><span class="w-2 h-4 bg-blue-500 inline-block animate-pulse"></span></div>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
            const typingContainer = document.getElementById(typingId);

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, email, chatId: activeChatId, lang: 'en', image: imagePayload })
                });
                if (!response.ok) {
                    let errorData = {};
                    try { errorData = await response.json(); } catch(e) {}
                    const errorTitle = response.status === 500 ? "‚ö†Ô∏è System Overload" : "üëë Premium Required";
                    const containerBox = document.getElementById(`container-${typingId}`);
                    containerBox.className = "msg-ai p-4 border border-red-500/50 bg-red-500/10 text-red-400 text-sm rounded-2xl rounded-tl-none max-w-[85%] mt-2 shadow-lg";
                    typingContainer.innerHTML = `<span class="font-bold text-base block mb-1">${errorTitle}</span>${errorData.text || "Connection blocked."}`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    return;
                }

                const newChatId = response.headers.get('X-Chat-Id');
                if (!activeChatId && newChatId) activeChatId = newChatId;
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let accumulatedText = "";
                let done = false;
                
                typingContainer.innerHTML = "";

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;
                    if (value) {
                        const chunk = decoder.decode(value, { stream: true });
                        accumulatedText += chunk;
                        typingContainer.innerHTML = formatAIResponse(accumulatedText) + '<span class="w-2 h-4 bg-blue-500 inline-block animate-pulse ml-1 align-middle"></span>';
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
                typingContainer.innerHTML = formatAIResponse(accumulatedText);
                loadSidebar();

            } catch (e) {
                typingContainer.innerHTML = "<span class='text-red-400'>Connection to AI Advisor lost.</span>";
            }
        }
        async function requestScan() {
            const query = document.getElementById('scanQuery').value;
            const customStore = document.getElementById('custom-store').value.trim();
            const minPrice = document.getElementById('min-price').value.trim();
            const maxPrice = document.getElementById('max-price').value.trim();
            const condition = document.getElementById('condition-val').value;
            const statusEl = document.getElementById('scanStatus');
            const btn = document.getElementById('scan-btn');
            const container = document.getElementById('scanner-container');

            if(!query) { statusEl.innerText = "‚ö†Ô∏è Enter product name"; return; }
            
            btn.disabled = true;
            if (container) container.classList.add('scanning'); 
            statusEl.className = "text-center text-xs font-mono h-4 text-blue-400 animate-pulse";
            
            const moodMessages = ["> Initializing...", "> Bypassing protection...", "> Analyzing AI data...", "> Extracting price..."];
            let moodIndex = 0;
            statusEl.innerText = moodMessages[0];
            const moodInterval = setInterval(() => {
                moodIndex++; if (moodIndex < moodMessages.length) statusEl.innerText = moodMessages[moodIndex];
            }, 1800);
            try {
                const response = await fetch('/api/scans?action=request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query, 
                        stores: customStore ? [customStore] : ['ebay'],
                        minPrice, maxPrice, condition
                    })
                });

                clearInterval(moodInterval);
                const data = await response.json();

                if (response.ok) {
                    statusEl.innerText = `‚úÖ Satellite deployed! Check history.`;
                    statusEl.className = "text-center text-xs font-mono h-4 text-green-500";
                } else {
                    statusEl.innerText = `‚ö†Ô∏è ${data.error || 'Limit reached or Error'}`;
                    statusEl.className = "text-center text-xs font-mono h-4 text-red-400";
                }
            } catch (e) { 
                clearInterval(moodInterval);
                statusEl.innerText = "‚ùå Connection error"; 
                statusEl.className = "text-center text-xs font-mono h-4 text-red-500";

            } finally { 
                setTimeout(() => { 
                    btn.disabled = false; 
                    statusEl.innerText = ""; 
                    if (container) container.classList.remove('scanning');
                }, 4000); 
            }
        }
        function openWatchdogModal() {
            const query = document.getElementById('scanQuery').value;
            const stores = document.getElementById('custom-store').value;
            const maxPrice = document.getElementById('max-price').value;
            
            document.getElementById('wd-modal-query').value = query;
            document.getElementById('wd-modal-stores').value = stores || 'ebay';
            document.getElementById('wd-modal-price').value = maxPrice;
            
            const modal = document.getElementById('watchdog-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.glass-panel').classList.remove('scale-95');
            }, 10);
        }

        function closeWatchdogModal() {
            const modal = document.getElementById('watchdog-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('.glass-panel').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        async function submitWatchdog() {
            const query = document.getElementById('wd-modal-query').value.trim();
            const customStoreInput = document.getElementById('wd-modal-stores').value.trim();
            const maxPrice = document.getElementById('wd-modal-price').value.trim();
            const interval = document.getElementById('wd-modal-interval').value;

            if(!query || !maxPrice) {
                alert("Target Hardware and Max Price are required.");
                return;
            }

            const stores = customStoreInput ? customStoreInput.split(',').map(s => s.trim().toLowerCase()) : ['ebay'];
            const btn = document.getElementById('wd-modal-submit');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Deploying...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/watchdog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, stores, targetPrice: maxPrice, condition: 'any', interval })
                });
                const data = await res.json();
                
                if (res.ok) {
                    btn.innerHTML = "‚úÖ Watchdog Active";
                    btn.className = "w-full bg-green-500 text-white font-black py-4 rounded-xl transition-all uppercase tracking-[0.1em] text-xs shadow-[0_0_20px_rgba(34,197,94,0.3)] mt-8";
                    setTimeout(() => {
                        closeWatchdogModal();
                        btn.innerHTML = originalText;
                        btn.className = "w-full bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 rounded-xl transition-all uppercase tracking-[0.1em] text-xs shadow-[0_0_20px_rgba(234,179,8,0.3)] mt-8";
                        btn.disabled = false;
                    }, 1500);
                } else {
                    alert(data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                alert("Connection failed.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        function filterHistory() {
            const input = document.getElementById('history-search').value.toLowerCase();
            const items = document.querySelectorAll('.history-item-card');

            items.forEach((item, index) => {
                const title = item.getAttribute('data-title').toLowerCase();
                const matches = title.includes(input);

                if (input.length > 0) {
                    item.style.display = matches ? 'block' : 'none';
                    item.style.opacity = "1"; 
                } else {
                    item.style.display = index < 5 ? 'block' : 'none';
                    item.style.opacity = index < 5 ? (1 - index * 0.15) : "1";
                }
            });
        }

        async function fetchLatestDeal() {
            if (document.hidden) return; 

            try {
                const res = await fetch(`/api/update_price`); 
                const data = await res.json();
                
                const dot = document.getElementById('system-status-dot');
                const text = document.getElementById('system-status-text');
                if (dot && text && data.systemStatus) {
                    const diff = (Date.now() - data.systemStatus.timestamp) / 1000;
                    if (diff > 120) { 
                        dot.className = "w-2.5 h-2.5 rounded-full bg-red-600 shadow-[0_0_10px_rgba(220,38,38,0.5)]";
                        text.innerText = "System Offline";
                        text.className = "text-[10px] uppercase tracking-widest text-red-500 font-bold";
                    } else {
                        dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse";
                        text.innerText = "System Online";
                        text.className = "text-[10px] uppercase tracking-widest text-blue-400 font-bold";
                    }
                }

                const historyArray = data.history || [];
                const list = document.getElementById('history-list');

                if (historyArray.length > 0 && list) {
                    let htmlContent = '';

                    historyArray.forEach((deal, index) => {
                        let listPrice = deal.price || "---";
                        if(listPrice.includes(":")) listPrice = listPrice.split(":")[1].trim();
                        const dealEscaped = encodeURIComponent(JSON.stringify(deal)).replace(/'/g, "%27");
                        
                        let badgeHtml = '';
                        if (deal.bestDeal) {
                            badgeHtml = `<span class="bg-yellow-500 text-black text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-widest shadow-[0_0_10px_rgba(234,179,8,0.5)] ml-2">üî• Best Deal</span>`;
                        } else if (deal.savingsPercent) {
                            badgeHtml = `<span class="bg-green-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-widest shadow-[0_0_10px_rgba(34,197,94,0.5)] ml-2">Save ${deal.savingsPercent}%</span>`;
                        }

                        const isHidden = index >= 5 ? 'style="display: none;"' : `style="opacity: ${1 - index * 0.15}"`;

                        htmlContent += `
                            <div data-title="${deal.title.replace(/"/g, '&quot;')}" onclick="MarketUI.openDetail('${dealEscaped}')" class="history-item-card glass-panel p-4 rounded-xl cursor-pointer hover:border-blue-500/30 transition-all border border-white/5" ${isHidden}>
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center">
                                        <span class="text-[10px] text-blue-400 font-bold uppercase">${deal.store || 'WEB'}</span>
                                        ${badgeHtml}
                                    </div>
                                    <span class="text-sm font-black text-white">${listPrice}</span>
                                </div>
                                <h3 class="text-gray-300 text-xs truncate">${deal.title || 'Product'}</h3>
                            </div>`;
                    });
                    
                    list.innerHTML = htmlContent;
                }
                return data;
            } catch (e) { 
                console.error("Fetch Error:", e); 
                return null;
            }
        }
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await loadLayout();
        
        if (window.MarketUI) {
            MarketUI.initChart('priceChart');
        }

        const res = await fetchLatestDeal(); 
                if (res && res.pusherKey) {
            MarketUI.initRealtime(res.pusherKey);
        }
        await loadSidebar();
        
        const chatBox = document.getElementById('chat-box');
        if (chatBox && chatBox.innerHTML.trim() === "") {
            startNewChat();
        }
    } catch (err) {
        console.error("Critical Init Error:", err);
    }
});
    </script>
</body>
</html>
